var Mark=function(e,t,n){"use strict";var a,i,r,o,l,s,d,c,u,g,m,f,h;return a=function(){var e,t,n=5,a=[],i=0,r=!1;return e=function(){var e,t=g();return a[i]&&a[i].text===t?!1:(e=h.getElementsByTagName("textarea")[0],a.splice(i+1),a.push({text:t,textarea:e?{index:Array.prototype.indexOf.call(e.parentNode.children,e),startOffset:e.selectionStart,endOffset:e.selectionEnd}:!1}),a.length>n&&a.shift(),i=a.length-1,r=!1,!0)},t=function(e){"forward"===e&&i<a.length-1?i++:"back"===e&&i&&i--;for(var t,n=d(a[i].text),r=n.length;h.firstChild;)h.removeChild(h.firstChild);for(t=0;r>t;t++)t===a[i].textarea.index?s("<br>"!==n[t].getAttribute("data-raw")?n[t].getAttribute("data-raw"):"").setSelectionRange(a[i].textarea.startOffset,a[i].textarea.endOffset):h.appendChild(n[t])},{states:a,push:e,back:function(){return t("back")},forward:function(){return t("forward")},isLocked:function(){return r},lock:function(){r=!0},unlock:function(){r=!1}}}(),i=function(e){var n,a,i,r,o=t.getSelection();return o.rangeCount?(r=o.getRangeAt(0),i=r.cloneRange(),i.selectNodeContents(e),i.setEnd(r.startContainer,r.startOffset),n=(""+i).replace(/\n/g,"").length,r.collapsed||(i.selectNodeContents(e),i.setEnd(r.endContainer,r.endOffset),a=(""+i).replace(/\n/g,"").length),{startOffset:n,endOffset:a||n,collapsed:r.collapsed}):{}},r=function(e,t,n){var a,i;for((n>t.length||void 0===n)&&(n=t.length),a=0,i=0;n>a;a++)e.charAt(a)!==t.charAt(i)?n++:i++;return n},o=function(e,t){var n,a;if(e.tagName===t.tagName&&("UL"===e.tagName||"OL"===e.tagName||"BLOCKQUOTE"===e.tagName)){for(n=t.children.length;n--;)e.insertBefore(t.lastElementChild,e.firstElementChild);e.setAttribute("data-raw",t.getAttribute("data-raw")+"\n"+e.getAttribute("data-raw")),t.parentNode.removeChild(t),a=e}return a||!1},l=function(e){e.rows=1,e.style.opacity=0;for(var n=1,a=e.scrollHeight,i=e.offsetHeight,r=t.getComputedStyle(e),o=i-parseInt(r.paddingTop,10)-parseInt(r.paddingBottom,10)-parseInt(r.borderTopWidth,10)-parseInt(r.borderBottomWidth,10);a>i;)i+=o,n++;return e.rows=n,e.style.opacity=1,e},s=function(e,t){var i=n.createElement("textarea");return i.addEventListener("input",function(){l(this)},!1),e&&(i.value=e),t?t.parentNode.insertBefore(i,t.nextSibling):"TEXTAREA"===n.activeElement.tagName?n.activeElement.parentNode.insertBefore(i,n.activeElement.nextSibling):h.appendChild(i),i.className="editing",i.focus(),a.states.length||a.push(),l(i)},d=function(t){var a=n.createElement("div");return a.innerHTML=e(t,{breaks:!0,addRaw:!0}),a.firstChild||(a.innerHTML='<p data-raw="<br>"><br></p>'),[].slice.call(a.children)},c=function(e){if("TEXTAREA"===e.tagName){var t,n=d(e.value),i=n.length;for(a.push(),e.previousSibling&&(t=o(n[0],e.previousSibling)),e.nextSibling&&(t=o(e.nextSibling,n[n.length-1]));i--;)t=e.parentNode.insertBefore(n[i],e.nextSibling);return e.parentNode.removeChild(e),t}},u=function(e){if("TEXTAREA"!==e.tagName){var t,n=e.textContent.replace(/\n/g,""),a=e.getAttribute("data-raw"),o=i(e);return"<br>"===a&&(a=""),o.startOffset=r(a,n,o.startOffset),o.endOffset=o.collapsed?o.startOffset:r(a,n,o.endOffset),t=s(a,e),t.setSelectionRange(o.startOffset,o.endOffset),e.parentNode.removeChild(e),t}},g=function(){var e,t="",n=h.children.length;for(e=0;n>e;e++)t+=h.children[e].getAttribute("data-raw")||h.children[e].value||"<br>",n-1>e&&(t+="\n\n");return t},m=function(){return e(g(),{breaks:!0})},f=function(e){var n;return h=e,t.addEventListener("keydown",function(e){90===e.keyCode&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),a.push(),e.shiftKey?a.forward():a.back())},!1),h.addEventListener("keydown",function(e){switch(e.keyCode){case 13:e.shiftKey||(e.preventDefault(),e.target.selectionStart!==e.target.value.length?(n=e.target.value.substring(e.target.selectionStart),e.target.value=e.target.value.substring(0,e.target.selectionStart)):n="",s(n,c(e.target)));break;case 46:case 8:e.target.selectionStart||e.target.selectionEnd||!e.target.previousSibling?a.isLocked()||(a.push(),a.lock()):(e.preventDefault(),a.unlock(),e.target.previousSibling.setAttribute("data-raw",e.target.previousSibling.getAttribute("data-raw").replace(/<br>/,"")+e.target.value),this.removeChild(u(e.target.previousSibling).nextSibling));break;case 27:c(e.target);break;case 37:case 38:!e.target.selectionStart&&e.target.previousSibling&&(e.preventDefault(),n=u(e.target.previousSibling),n.setSelectionRange(n.value.length,n.value.length),c(e.target));break;case 39:case 40:e.target.selectionStart===e.target.value.length&&e.target.nextSibling&&(e.preventDefault(),u(e.target.nextSibling).setSelectionRange(0,0),c(e.target))}},!1),h.addEventListener("mousedown",function(e){n=e.target},!1),h.addEventListener("mouseup",function(e){var t,a,i=this,r=n===i?e.target:n;if(r&&"TEXTAREA"!==r.tagName){if(t=i.getElementsByTagName("textarea")[0],t&&c(t),r!==i&&"A"!==r.tagName){for(a=r;a.parentNode!==i;)a=a.parentNode;u(a)}r===i&&!t&&i.lastChild&&u(i.lastChild)}},!1),h},{convert:d,getText:g,getHTML:m,init:f,newline:s,render:c,unrender:u}}(marked,window,document);