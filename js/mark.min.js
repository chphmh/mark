var Mark=function(e,t,n){"use strict";var r,a,i,l,s,o,g,c,u,d,f,v,h;return r=function(){var e,t,n=5,r=[],a=0,i=!1;return e=function(){var e,t=d();return r[a]&&r[a].text===t?!1:(e=h.getElementsByTagName("textarea")[0],r.splice(a+1),r.push({text:t,textarea:e?{index:Array.prototype.indexOf.call(e.parentNode.children,e),startOffset:e.selectionStart,endOffset:e.selectionEnd}:!1}),r.length>n&&r.shift(),a=r.length-1,i=!1,!0)},t=function(e){"forward"===e&&a<r.length-1?a++:"back"===e&&a&&a--;for(var t,n=g(r[a].text),i=n.length;h.firstChild;)h.removeChild(h.firstChild);for(t=0;i>t;t++)t===r[a].textarea.index?o("<br>"!==n[t].getAttribute("data-raw")?n[t].getAttribute("data-raw"):"").setSelectionRange(r[a].textarea.startOffset,r[a].textarea.endOffset):h.appendChild(n[t])},{states:r,push:e,back:function(){return t("back")},forward:function(){return t("forward")},isLocked:function(){return i},lock:function(){i=!0},unlock:function(){i=!1}}}(),a=function(e){var n,r,a,i,l=t.getSelection();return l.rangeCount?(i=l.getRangeAt(0),a=i.cloneRange(),a.selectNodeContents(e),a.setEnd(i.startContainer,i.startOffset),n=(""+a).replace(/\n/g,"").length,i.collapsed||(a.selectNodeContents(e),a.setEnd(i.endContainer,i.endOffset),r=(""+a).replace(/\n/g,"").length),{startOffset:n,endOffset:r||n,collapsed:i.collapsed}):!1},i=function(e,t,n){var r,a;for((n>t.length||void 0===n)&&(n=t.length),r=0,a=0;n>r;r++)e.charAt(r)!==t.charAt(a)?n++:a++;return n},l=function(e,t){var n,r;if(e.tagName===t.tagName&&("UL"===e.tagName||"OL"===e.tagName||"BLOCKQUOTE"===e.tagName)){for(n=t.children.length;n--;)e.insertBefore(t.lastElementChild,e.firstElementChild);e.setAttribute("data-raw",t.getAttribute("data-raw")+"\n"+e.getAttribute("data-raw")),t.parentNode.removeChild(t),r=e}return r||!1},s=function(e){e.rows=1,e.style.opacity=0;for(var t=e.rows,n=e.scrollHeight,r=e.offsetHeight;n>r*t;)t++;return e.rows=t,e.style.opacity=1,e},o=function(e,t){var a=n.createElement("textarea");return a.addEventListener("input",function(){s(this)},!1),e&&(a.value=e),t?t.parentNode.insertBefore(a,t.nextSibling):"TEXTAREA"===n.activeElement.tagName?n.activeElement.parentNode.insertBefore(a,n.activeElement.nextSibling):h.appendChild(a),a.className="editing",a.focus(),r.states.length||r.push(),s(a)},g=function(t){var r=n.createElement("div");return r.innerHTML=e(t,{breaks:!0,addRaw:!0}),r.firstChild||(r.innerHTML='<p data-raw="<br>"><br></p>'),[].slice.call(r.children)},c=function(e){if("TEXTAREA"===e.tagName){var t,n=g(e.value),a=n.length;for(r.push(),e.previousSibling&&(t=l(n[0],e.previousSibling)),e.nextSibling&&(t=l(e.nextSibling,n[n.length-1]));a--;)t=e.parentNode.insertBefore(n[a],e.nextSibling);return e.parentNode.removeChild(e),t}},u=function(e){if("TEXTAREA"!==e.tagName){var t,n=e.textContent.replace(/\n/g,""),r=e.getAttribute("data-raw"),l=a(e);return"<br>"===r&&(r=""),l.startOffset=i(r,n,l.startOffset),l.endOffset=l.collapsed?l.startOffset:i(r,n,l.endOffset),t=o(r,e),t.setSelectionRange(l.startOffset,l.endOffset),e.parentNode.removeChild(e),t}},d=function(){var e,t="",n=h.children.length;for(e=0;n>e;e++)t+=h.children[e].getAttribute("data-raw")||h.children[e].value||"<br>",n-1>e&&(t+="\n\n");return t},f=function(){return e(d(),{breaks:!0})},v=function(e){var n;return h=e,t.addEventListener("keydown",function(e){90===e.keyCode&&(e.metaKey||e.ctrlKey)&&(e.preventDefault(),r.push(),e.shiftKey?r.forward():r.back())},!1),h.addEventListener("keydown",function(e){switch(e.keyCode){case 13:e.shiftKey||(e.preventDefault(),e.target.selectionStart!==e.target.value.length?(n=e.target.value.substring(e.target.selectionStart),e.target.value=e.target.value.substring(0,e.target.selectionStart)):n="",o(n,c(e.target)));break;case 46:case 8:e.target.selectionStart||e.target.selectionEnd||!e.target.previousSibling?r.isLocked()||(r.push(),r.lock()):(e.preventDefault(),r.unlock(),e.target.previousSibling.setAttribute("data-raw",e.target.previousSibling.getAttribute("data-raw").replace(/<br>/,"")+e.target.value),this.removeChild(u(e.target.previousSibling).nextSibling));break;case 27:c(e.target);break;case 37:case 38:!e.target.selectionStart&&e.target.previousSibling&&(e.preventDefault(),n=u(e.target.previousSibling),n.setSelectionRange(n.value.length,n.value.length),c(e.target));break;case 39:case 40:e.target.selectionStart===e.target.value.length&&e.target.nextSibling&&(e.preventDefault(),u(e.target.nextSibling).setSelectionRange(0,0),c(e.target))}},!1),h.addEventListener("mousedown",function(e){n=e.target},!1),h.addEventListener("mouseup",function(e){var t,r,a=this,i=n===a?e.target:n;if(i&&"TEXTAREA"!==i.tagName){if(t=a.getElementsByTagName("textarea")[0],t&&c(t),i!==a&&"A"!==i.tagName){for(r=i;r.parentNode!==a;)r=r.parentNode;u(r)}i===a&&!t&&a.lastChild&&u(a.lastChild)}},!1),h},{convert:g,getText:d,getHTML:f,init:v,newline:o,render:c,unrender:u}}(marked,window,document);